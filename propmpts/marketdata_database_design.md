# Database Design (Supabase)

This document outlines the database schema for the Market Data system, designed to be hosted on **Supabase** (PostgreSQL).

---

## Proposed Table Structure
The data is normalized into two main tables: one for static contract details and one for time-series price data.

### 1. Table: `options_contracts`
Stores the static information about the option symbol. This data rarely changes.

| Column Name | Type | Description |
| :--- | :--- | :--- |
| **`symbol`** | `VARCHAR(50)` (PK) | The unique option symbol (e.g., `GFGC26549D`). Primary Key. |
| `underlying_symbol` | `VARCHAR(20)` | The stock symbol (e.g., `GGAL`). |
| `type` | `VARCHAR(10)` | `Call` or `Put`. |
| `expiration_date` | `TIMESTAMPTZ` | The expiration date of the option (Timezone aware). |
| `strike` | `DECIMAL(12, 3)` | The strike price of the option. |
| `description` | `TEXT` | Human-readable description. |

### 2. Table: `market_prices`
Stores the price information fetched at specific times.

| Column Name | Type | Description |
| :--- | :--- | :--- |
| **`id`** | `BIGINT` (PK) | Auto-incrementing unique ID (`GENERATED BY DEFAULT AS IDENTITY`). |
| `contract_symbol` | `VARCHAR(50)` (FK) | Foreign Key referencing `options_contracts.symbol`. |
| `price` | `DECIMAL(12, 3)` | The last price (`ultimoPrecio`) |
| `broker_timestamp` | `TIMESTAMPTZ` | The time of the data point (`fechaHora`). |
| `system_timestamp` | `TIMESTAMPTZ` | The time of the system when the data was fetched. |
| `volume` | `INTEGER` | Optional: Volume traded (`volumenNominal`). |

### 3. Table: `positions` (Strategy Container)
Represents a high-level strategy or "complex position".

| Column Name | Type | Description |
| :--- | :--- | :--- |
| **`id`** | `BIGINT` (PK) | Unique position ID. |
| `name` | `VARCHAR(100)` | Name of the strategy. |
| `description` | `TEXT` | Optional description. |
| `status` | `VARCHAR(20)` | State of the position ('OPEN', 'CLOSED'). |
| `created_at` | `TIMESTAMPTZ` | Creation date (Default: `NOW()`). |

### 4. Table: `operations` (Trades)
Stores individual buy/sell transactions.

| Column Name | Type | Description |
| :--- | :--- | :--- |
| **`id`** | `BIGINT` (PK) | Unique operation ID. |
| `contract_symbol` | `VARCHAR(50)` (FK) | Reference to `options_contracts.symbol`. |
| `operation_type` | `VARCHAR(4)` | 'BUY' or 'SELL'. |
| `quantity` | `INTEGER` | Number of contracts traded. |
| `price` | `DECIMAL(12, 3)` | Premium per contract. |
| `operation_date` | `TIMESTAMPTZ` | When the trade occurred (Default: `NOW()`). |

### 5. Table: `position_contains_operations`
Many-to-many relationship between `positions` and `operations`.

| Column Name | Type | Description |
| :--- | :--- | :--- |
| **`position_id`** | `BIGINT` (FK) | Reference to the `positions` table. |
| `operation_id` | `BIGINT` (FK) | Reference to the `operations` table. |

### 6. Table: `daily_operated_volumes`
Stores daily aggregated volume information for options.

| Column Name | Type | Description |
| :--- | :--- | :--- |
| **`id`** | `BIGINT` (PK) | Unique ID. |
| `symbol` | `VARCHAR(50)` (FK) | Reference to `options_contracts.symbol`. |
| `covered` | `INTEGER` | Covered volume. |
| `opposed` | `INTEGER` | Opposed volume. |
| `crossed` | `INTEGER` | Crossed volume. |
| `uncovered` | `INTEGER` | Uncovered volume. |
| `total` | `INTEGER` | Total volume. |
| `date` | `DATE` | The date of the record (Default: `CURRENT_DATE`). |

### SQL Creation Script (PostgreSQL)

```sql
-- Create Contracts Table
CREATE TABLE options_contracts (
    symbol VARCHAR(50) PRIMARY KEY,
    underlying_symbol VARCHAR(20),
    type VARCHAR(10),
    expiration_date TIMESTAMPTZ,
    strike DECIMAL(12, 3),
    description TEXT
);

-- Enable Row Level Security (RLS) - Recommended for Supabase
ALTER TABLE options_contracts ENABLE ROW LEVEL SECURITY;

-- Create Prices Table
CREATE TABLE market_prices (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    contract_symbol VARCHAR(50) REFERENCES options_contracts(symbol),
    price DECIMAL(12, 3),
    broker_timestamp TIMESTAMPTZ,
    system_timestamp TIMESTAMPTZ DEFAULT NOW(),
    volume INTEGER
);
ALTER TABLE market_prices ENABLE ROW LEVEL SECURITY;

-- Create Positions Table
CREATE TABLE positions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(100),
    description TEXT,
    status VARCHAR(20) DEFAULT 'OPEN', -- OPEN, CLOSED
    created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE positions ENABLE ROW LEVEL SECURITY;

-- Create Operations Table
CREATE TABLE operations (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    contract_symbol VARCHAR(50) REFERENCES options_contracts(symbol),
    operation_type VARCHAR(4) CHECK (operation_type IN ('BUY', 'SELL')),
    quantity INTEGER NOT NULL,
    price DECIMAL(12, 3) NOT NULL,
    operation_date TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE operations ENABLE ROW LEVEL SECURITY;

-- Create Position-Operations Link Table
CREATE TABLE position_contains_operations (
    position_id BIGINT REFERENCES positions(id),
    operation_id BIGINT REFERENCES operations(id),
    PRIMARY KEY (position_id, operation_id)
);
ALTER TABLE position_contains_operations ENABLE ROW LEVEL SECURITY;

-- Create Daily Operated Volumes Table
CREATE TABLE daily_operated_volumes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    symbol VARCHAR(50) REFERENCES options_contracts(symbol),
    covered INTEGER,
    opposed INTEGER,
    crossed INTEGER,
    uncovered INTEGER,
    total INTEGER,
    date DATE DEFAULT CURRENT_DATE
);
ALTER TABLE daily_operated_volumes ENABLE ROW LEVEL SECURITY;

-- Enable Realtime for market_prices (Supabase specific)
-- allow listening to INSERTs
alter publication supabase_realtime add table market_prices;
```

---

# Table Views

## Read the newest price from `market_prices` table

```sql
WITH LatestPrices AS (
    SELECT
        contract_symbol,
        price,
        system_timestamp,
        ROW_NUMBER() OVER(PARTITION BY contract_symbol ORDER BY system_timestamp DESC) as rn
    FROM
        market_prices
)
SELECT
    oc.symbol,
    lp.price,
    lp.system_timestamp
FROM
    options_contracts oc
JOIN
    LatestPrices lp ON oc.symbol = lp.contract_symbol
WHERE
    lp.rn = 1;
```

## Get a list of the `system_timestamps` from `market_prices` table

```sql
SELECT DISTINCT system_timestamp
FROM market_prices
ORDER BY system_timestamp DESC;
```

## Get prices from `market_prices` table ordered by `system_timestamp`

### Return the prices of a given contract symbol ordered by `system_timestamp`.

```sql
SELECT
    contract_symbol,
    price,
    system_timestamp
FROM
    market_prices
WHERE
    contract_symbol = :symbol
ORDER BY
    system_timestamp DESC;
```
